<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메이플관리 - 집노트</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* 사이드바 */
        .sidebar {
            width: 260px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #64748b;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: #f1f5f9;
            color: #6366f1;
        }
        
        .nav-item.active {
            background: #f1f5f9;
            color: #6366f1;
            border-left-color: #6366f1;
        }
        
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 메인 컨텐츠 */
        .main-content {
            flex: 1;
            margin-left: 260px;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 12px;
            background: #f8fafc;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            font-size: 12px;
            color: #64748b;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .logout-btn:hover {
            background: #dc2626;
        }
        
        /* 컨텐츠 */
        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }
        
        .page-header {
            margin-bottom: 32px;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .page-subtitle {
            color: #64748b;
            font-size: 16px;
        }
        
        /* 테이블 */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .table-header {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 필터 섹션 */
        .filter-section {
            padding: 12px 24px;
            border-bottom: 1px solid #e2e8f0;
            background: #ffffff;
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-label {
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            margin-right: 4px;
        }
        .filter-buttons {
            display: flex;
            gap: 6px;
        }
        .filter-btn {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            background: #ffffff;
            color: #334155;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
        }
        .filter-btn.active {
            background: #e0e7ff;
            color: #4338ca;
            border-color: #c7d2fe;
            font-weight: 600;
        }
        
        /* 정렬 버튼 */
        .sort-header {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            user-select: none;
        }
        
        .sort-header:hover {
            color: #6366f1;
        }
        
        .sort-icon {
            font-size: 12px;
            color: #9ca3af;
            transition: color 0.2s ease;
        }
        
        .sort-header.active .sort-icon {
            color: #6366f1;
        }
        
        .sort-header.desc .sort-icon:after {
            content: '▼';
        }
        
        .sort-header.asc .sort-icon:after {
            content: '▲';
        }
        

        
        .sort-header:not(.active) .sort-icon:after {
            content: '↕️';
        }
        
        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a202c;
        }
        
        .add-btn {
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-btn:hover {
            background: #5855eb;
        }
        
        .maeiple-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .maeiple-table th {
            background: #f8fafc;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .maeiple-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #374151;
        }
        
        .maeiple-table tr:hover {
            background: #f8fafc;
        }
        
        /* 새 행 스타일 */
        .new-row {
            background: #f0f9ff !important;
            border-left: 4px solid #3b82f6;
        }
        
        .new-row:hover {
            background: #e0f2fe !important;
        }
        
        /* 셀 스타일 */
        .date-cell {
            cursor: pointer;
            position: relative;
        }
        
        .date-cell:hover {
            background-color: #f0f9ff;
        }
        
        .number-cell {
            cursor: pointer;
            font-weight: 500;
        }
        
        .number-cell:hover {
            background-color: #f0f9ff;
        }
        
        .price-cell {
            cursor: pointer;
            color: #2563eb;
            font-weight: 500;
        }
        
        .price-cell:hover {
            background-color: #f0f9ff;
        }
        
        .monthly-rent-container {
            display: flex;
            align-items: center;
        }
        
        .deposit {
            cursor: pointer;
            margin-right: 2px;
            color: #6366f1;
        }
        
        .monthly {
            cursor: pointer;
            color: #2563eb;
            font-weight: 500;
        }
        
        .deposit:hover, .monthly:hover {
            background-color: #f0f9ff;
        }
        
        .phone-cell {
            cursor: pointer;
            font-family: monospace;
            letter-spacing: 0.5px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .phone-cell:hover {
            background-color: #f0f9ff;
        }
        
        .memo-preview {
            cursor: pointer;
            color: #64748b;
            font-style: italic;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .memo-preview:hover {
            background-color: #f0f9ff;
            color: #334155;
        }
        
        .like-rating, .dislike-rating {
            cursor: pointer;
            letter-spacing: -2px;
        }
        
        /* 팝업 메뉴 */
        .popup-menu {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: 8px 0;
        }
        
        .popup-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .popup-menu-item:hover {
            background: #f8fafc;
        }
        
        .popup-menu-item.active {
            background: #e0f2fe;
            color: #2563eb;
            font-weight: 500;
        }
        
        /* 좋아요/싫어요 팝업 */
        .rating-popup {
            display: flex;
            padding: 8px;
            gap: 4px;
        }
        
        .rating-option {
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .rating-option:hover {
            background: #f0f9ff;
        }
        
        /* 작업 버튼 */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* 상태 토글 버튼 */
        .status-toggle {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .status-trading {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* 새로운 현황 색상 매핑 */
        .status-available {
            background: #e0f2fe; /* sky-100 */
            color: #0369a1;      /* sky-700 */
        }
        .status-hold {
            background: #fef3c7; /* amber-100 */
            color: #92400e;      /* amber-800 */
        }
        .status-absent {
            background: #ede9fe; /* violet-100 */
            color: #5b21b6;      /* violet-800 */
        }
        
        /* 좋아요/싫어요 */
        .like-dislike {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .like-btn, .dislike-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .like-btn:hover {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .dislike-btn:hover {
            background: #f0f9ff;
            color: #2563eb;
        }
        
        .like-count, .dislike-count {
            font-size: 12px;
            font-weight: 500;
            min-width: 20px;
            text-align: center;
        }
        
        /* 메모 아이콘 */
        .memo-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .memo-icon:hover {
            background: #f3f4f6;
        }
        
        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a202c;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        
        .close:hover {
            color: #1a202c;
        }
        
        .memo-textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        
        .memo-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5855eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        /* 입력 필드 */
        .input-field {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .input-small {
            width: 80px;
        }
        
        /* 실거주 여부 토글 */
        .occupied-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .occupied-toggle:hover {
            background: #f3f4f6;
        }
        
        .occupied-yes {
            color: #059669;
        }
        
        .occupied-no {
            color: #dc2626;
        }
        
        /* 로딩 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">🏠</div>
                    <div class="logo-text">집노트</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">
                    <div class="nav-icon">📊</div>
                    대시보드
                </a>
                <a href="/maeiple" class="nav-item active">
                    <div class="nav-icon">🏢</div>
                    메이플관리
                </a>
                <a href="#" class="nav-item" id="guarantee-log-menu">
                    <div class="nav-icon">🛡️</div>
                    보증보험
                </a>
                <a href="/logout" class="nav-item">
                    <div class="nav-icon">🚪</div>
                    로그아웃
                </a>
            </nav>
        </div>
        
        <!-- 메인 컨텐츠 -->
        <div class="main-content">
            <!-- 헤더 -->
            <div class="header">
                <div class="header-left">
                    <h2>메이플관리</h2>
                </div>
                
                <div class="header-right">
                    <div class="user-profile">
                        <div class="user-avatar">{{ employee_name[0] if employee_name else '직' }}</div>
                        <div class="user-info">
                            <div class="user-name">{{ employee_name or '직원' }}</div>
                            <div class="user-role">직원</div>
                        </div>
                    </div>
                    <a href="/logout" class="logout-btn">로그아웃</a>
                </div>
            </div>
            
            <!-- 컨텐츠 -->
            <div class="content">
                <div class="page-header">
                    <h1 class="page-title">아파트목록</h1>
                    <p class="page-subtitle">매물 현황 및 관리</p>
                </div>
                
                <!-- 매물 테이블 -->
                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">매물 리스트</h2>
                        <button class="add-btn" onclick="addNewPropertyRow()">+ 새 매물 추가</button>
                    </div>
                 <div class="filter-section">
                     <!-- 호수 검색 -->
                     <div class="filter-group">
                         <span class="filter-label">호수 검색:</span>
                         <input type="text" id="room-search" placeholder="호수 입력 (예: 101, 102)" 
                                style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; width: 120px;"
                                oninput="filterByRoom(this.value)">
                     </div>
                     
                     <!-- 거래 유형 필터 -->
                     <div class="filter-group" id="deal-type-filter-group">
                         <span class="filter-label">거래유형:</span>
                         <div class="filter-buttons">
                             <button class="filter-btn active" data-value="all" onclick="setDealTypeFilter('all', this)">전체</button>
                             <button class="filter-btn" data-value="전세" onclick="setDealTypeFilter('전세', this)">전세</button>
                             <button class="filter-btn" data-value="월세" onclick="setDealTypeFilter('월세', this)">월세</button>
                             <button class="filter-btn" data-value="매매" onclick="setDealTypeFilter('매매', this)">매매</button>
                         </div>
                     </div>
                     
                     <div class="filter-group" id="status-filter-group">
                         <span class="filter-label">현황:</span>
                         <div class="filter-buttons">
                             <button class="filter-btn active" data-value="all" onclick="setStatusFilter('all', this)">전체</button>
                             <button class="filter-btn" data-value="거래가능" onclick="setStatusFilter('거래가능', this)">거래가능</button>
                             <button class="filter-btn" data-value="계약완료" onclick="setStatusFilter('계약완료', this)">계약완료</button>
                             <button class="filter-btn" data-value="보류" onclick="setStatusFilter('보류', this)">보류</button>
                             <button class="filter-btn" data-value="부재" onclick="setStatusFilter('부재', this)">부재</button>
                         </div>
                     </div>
                     <div class="filter-group" id="occupied-filter-group">
                         <span class="filter-label">실거주:</span>
                         <div class="filter-buttons">
                             <button class="filter-btn active" data-value="all" onclick="setOccupiedFilter('all', this)">전체</button>
                             <button class="filter-btn" data-value="O" onclick="setOccupiedFilter('O', this)">O</button>
                             <button class="filter-btn" data-value="X" onclick="setOccupiedFilter('X', this)">X</button>
                         </div>
                     </div>
                     
                     <!-- 팀 필터 (팀장인 경우만 표시) -->
                     <div class="filter-group" id="team-filter-group" style="display: none;">
                         <span class="filter-label">팀:</span>
                         <div class="filter-buttons">
                             <button class="filter-btn active" data-value="all" onclick="setTeamFilter('all', this)">전체</button>
                             <button class="filter-btn" data-value="current" onclick="setTeamFilter('current', this)">현재팀</button>
                         </div>
                     </div>
                 </div>
                    
                    <div id="table-content">
                        <div class="loading">로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 메모 모달 -->
    <div id="memoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">특이사항 메모</h3>
                <button class="close" onclick="closeMemoModal()">&times;</button>
            </div>
            <textarea id="memoTextarea" class="memo-textarea" placeholder="메모를 입력하세요..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeMemoModal()">취소</button>
                <button class="btn btn-primary" onclick="saveMemo()">저장</button>
            </div>
        </div>
    </div>
    

    
    <script>
        let properties = [];
        let statusFilter = 'all';
        let occupiedFilter = 'all';
        let dealTypeFilter = 'all';
        let roomSearchFilter = '';
        let teamFilter = 'all';
        let currentMemoId = null;
        let currentSortBy = 'check_date';
        let currentSortOrder = 'desc';
        let currentUserTeam = '';
        let isTeamLeader = false;
        
        // 페이지 로드 시 사용자 정보 확인 및 매물 목록 조회
        document.addEventListener('DOMContentLoaded', async function() {
            await checkUserInfo();
            loadProperties();
        });
        
        // 사용자 정보 확인
        async function checkUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                if (response.ok) {
                    const userInfo = await response.json();
                    currentUserTeam = userInfo.employee_team || '';
                    isTeamLeader = userInfo.role === '팀장' || userInfo.employee_role === '팀장';
                    
                    // 팀장인 경우 팀 필터 표시
                    if (isTeamLeader) {
                        document.getElementById('team-filter-group').style.display = 'flex';
                        console.log('🎯 팀장 권한 확인 - 팀 필터 활성화');
                    }
                    
                    console.log('👤 사용자 정보:', userInfo);
                    console.log('🏢 현재 팀:', currentUserTeam);
                    console.log('👑 팀장 여부:', isTeamLeader);
                }
            } catch (error) {
                console.error('사용자 정보 확인 오류:', error);
            }
        }
        
        // 매물 목록 조회
        async function loadProperties() {
            try {
                const url = `/api/maeiple?sort_by=${currentSortBy}&sort_order=${currentSortOrder}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    properties = data.properties;
                    renderProperties();
                } else {
                    showError('매물 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('매물 목록을 불러오는데 실패했습니다.');
            }
        }
        
        // 매물 목록 렌더링
        function renderProperties() {
            const tableContent = document.getElementById('table-content');
            
            // 필터 적용
            let list = Array.isArray(properties) ? properties.slice() : [];
            
            // 현황 필터
            if (statusFilter !== 'all') {
                list = list.filter(p => (p.status || '') === statusFilter);
            }
            
            // 실거주 필터
            if (occupiedFilter !== 'all') {
                const want = occupiedFilter === 'O';
                list = list.filter(p => !!p.is_occupied === want);
            }
            
            // 거래유형 필터 (금액이 입력된 경우만 해당 거래유형으로 분류)
            if (dealTypeFilter !== 'all') {
                list = list.filter(p => {
                    if (dealTypeFilter === '전세') {
                        const jeonsePrice = parseInt(String(p.jeonse_price || '0').replace(/[^\d]/g, '')) || 0;
                        return jeonsePrice > 0;
                    } else if (dealTypeFilter === '월세') {
                        const monthlyRent = parseInt(String(p.monthly_rent || '0').replace(/[^\d]/g, '')) || 0;
                        return monthlyRent > 0;
                    } else if (dealTypeFilter === '매매') {
                        const salePrice = parseInt(String(p.sale_price || '0').replace(/[^\d]/g, '')) || 0;
                        return salePrice > 0;
                    }
                    return true;
                });
            }
            
            // 호수 검색 필터
            if (roomSearchFilter.trim()) {
                const searchTerm = roomSearchFilter.trim().toLowerCase();
                list = list.filter(p => {
                    const roomNumber = String(p.room_number || '').toLowerCase();
                    return roomNumber.includes(searchTerm);
                });
            }
            
            // 팀 필터 (팀장인 경우만 적용)
            if (isTeamLeader && teamFilter === 'current' && currentUserTeam) {
                list = list.filter(p => p.employee_team === currentUserTeam);
                console.log(`🏢 팀 필터 적용: ${currentUserTeam}팀 매물 ${list.length}개`);
            }
            
            if (list.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🏢</div>
                        <p>조건에 맞는 매물이 없습니다.</p>
                        <p>필터를 변경하거나 새 매물을 추가해보세요.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table class="maeiple-table">
                    <thead>
                        <tr>
                            <th>
                                <div class="sort-header ${currentSortBy === 'check_date' ? 'active ' + currentSortOrder : ''}" 
                                     onclick="toggleSort('check_date')">
                                    확인날짜
                                    <span class="sort-icon"></span>
                                </div>
                            </th>
                            <th>동</th>
                            <th>호수</th>
                            <th>현황</th>
                            <th>전세 (만원)</th>
                            <th>월세보증금 (만원)</th>
                            <th>월세 (만원)</th>
                            <th>매매 (만원)</th>
                            <th>실거주 여부</th>
                            <th>전화번호</th>
                            <th>특이사항</th>
                            <th>좋아요</th>
                            <th>싫어요</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            list.forEach(property => {
                const memoPreview = property.memo ? (property.memo.length > 20 ? property.memo.substring(0, 20) + '...' : property.memo) : '';
                
                tableHTML += `
                    <tr data-property-id="${property.id}">
                        <td class="date-cell" onclick="editDate(${property.id}, '${property.check_date || ''}', this)">${property.check_date || ''}</td>
                        <td class="number-cell" onclick="editNumber(${property.id}, 'building_number', '${property.building_number || ''}', this)">${property.building_number || ''}</td>
                        <td class="number-cell" onclick="editNumber(${property.id}, 'room_number', '${property.room_number || ''}', this)">${property.room_number || ''}</td>
                        <td>
                            <button class="status-toggle ${property.status === '계약완료' ? 'status-completed' : property.status === '보류' ? 'status-hold' : property.status === '부재' ? 'status-absent' : 'status-available'}" 
                                    onclick="showStatusOptions(${property.id}, '${property.status || '거래가능'}', this)">
                                ${property.status || '거래가능'}
                            </button>
                        </td>
                        <td class="price-cell" onclick="editPrice(${property.id}, 'jeonse_price', '${property.jeonse_price || ''}', this)">
                            ${property.jeonse_price ? formatNumber(property.jeonse_price) + ' 만원' : '-'}
                        </td>
                        <td class="price-cell" onclick="editPrice(${property.id}, 'deposit', '${property.deposit || ''}', this)">
                            ${property.deposit ? formatNumber(property.deposit) + ' 만원' : '-'}
                        </td>
                        <td class="price-cell" onclick="editPrice(${property.id}, 'monthly_rent', '${property.monthly_rent || ''}', this)">
                            ${property.monthly_rent ? formatNumber(property.monthly_rent) + ' 만원' : '-'}
                        </td>
                        <td class="price-cell" onclick="editPrice(${property.id}, 'sale_price', '${property.sale_price || ''}', this)">
                            ${property.sale_price ? formatNumber(property.sale_price) + ' 만원' : '-'}
                        </td>
                        <td>
                            <button class="occupied-toggle ${property.is_occupied ? 'occupied-yes' : 'occupied-no'}" 
                                    onclick="toggleOccupied(${property.id}, ${property.is_occupied})">
                                ${property.is_occupied ? 'O' : 'X'}
                            </button>
                        </td>
                        <td class="phone-cell" onclick="editPhone(${property.id}, '${property.phone || ''}', this)">
                            ${property.phone || '-'}
                        </td>
                        <td class="memo-preview" onclick="showMemoModal(${property.id}, '${property.memo || ''}')">
                            ${memoPreview || '메모 추가...'}
                        </td>
                        <td>
                            <div class="like-dislike">
                                <div class="like-rating" onclick="showLikeOptions(${property.id}, ${property.likes}, this)">
                                    ${'❤️'.repeat(property.likes)}${property.likes === 0 ? '🤍' : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="like-dislike">
                                <div class="dislike-rating" onclick="showDislikeOptions(${property.id}, ${property.dislikes}, this)">
                                    ${'👎'.repeat(property.dislikes)}${property.dislikes === 0 ? '🤍' : ''}
                                </div>
                            </div>
                        </td>

                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContent.innerHTML = tableHTML;
        }

        // 숫자 3자리 콤마
        function formatNumber(val) {
            const n = typeof val === 'number' ? val : parseInt(String(val).replace(/[^\d-]/g, ''), 10);
            if (isNaN(n)) return '';
            return n.toLocaleString('ko-KR');
        }
        
        // 현황 토글
        async function toggleStatus(id, currentStatus) {
            const newStatus = currentStatus === '거래가능' ? '계약완료' : '거래가능';
            
            try {
                const response = await fetch('/api/maeiple/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        field: 'status',
                        value: newStatus
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 로컬 상태 업데이트
                    const property = properties.find(p => p.id === id);
                    if (property) {
                        property.status = newStatus;
                        renderProperties();
                    }
                } else {
                    showError('상태 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('상태 업데이트에 실패했습니다.');
            }
        }
        
        // 팀 필터 설정
        function setTeamFilter(value, button) {
            // 모든 팀 필터 버튼 비활성화
            document.querySelectorAll('#team-filter-group .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 클릭된 버튼 활성화
            button.classList.add('active');
            teamFilter = value;
            
            // 매물 목록 다시 렌더링
            renderProperties();
        }
        
        // 실거주 여부 토글
        async function toggleOccupied(id, currentOccupied) {
            const newOccupied = !currentOccupied;
            
            try {
                const response = await fetch('/api/maeiple/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        field: 'is_occupied',
                        value: newOccupied
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 로컬 상태 업데이트
                    const property = properties.find(p => p.id === id);
                    if (property) {
                        property.is_occupied = newOccupied;
                        renderProperties();
                    }
                } else {
                    showError('실거주 여부 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('실거주 여부 업데이트에 실패했습니다.');
            }
        }
        
        // 필드 업데이트
        async function updateField(id, field, value) {
            try {
                const response = await fetch('/api/maeiple/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        field: field,
                        value: value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 로컬 상태 업데이트
                    const property = properties.find(p => p.id === id);
                    if (property) {
                        property[field] = value;
                        if (field === 'status' || field === 'is_occupied') {
                            // 필터 반영을 위해 재렌더
                            renderProperties();
                        }
                    }
                } else {
                    showError('업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('업데이트에 실패했습니다.');
            }
        }
        
        // 좋아요 업데이트
        async function updateLikes(id, currentLikes, increment) {
            const newLikes = Math.min(5, Math.max(0, currentLikes + increment));
            
            try {
                const response = await fetch('/api/maeiple/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        field: 'likes',
                        value: newLikes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 로컬 상태 업데이트
                    const property = properties.find(p => p.id === id);
                    if (property) {
                        property.likes = newLikes;
                        renderProperties();
                    }
                } else {
                    showError('좋아요 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('좋아요 업데이트에 실패했습니다.');
            }
        }
        
        // 싫어요 업데이트
        async function updateDislikes(id, currentDislikes, increment) {
            const newDislikes = Math.min(5, Math.max(0, currentDislikes + increment));
            
            try {
                const response = await fetch('/api/maeiple/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        field: 'dislikes',
                        value: newDislikes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 로컬 상태 업데이트
                    const property = properties.find(p => p.id === id);
                    if (property) {
                        property.dislikes = newDislikes;
                        renderProperties();
                    }
                } else {
                    showError('싫어요 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('싫어요 업데이트에 실패했습니다.');
            }
        }

        // 정렬 기능
        async function toggleSort(field) {
            if (currentSortBy === field) {
                // 같은 필드를 클릭한 경우 정렬 순서 변경
                currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
            } else {
                // 다른 필드를 클릭한 경우 해당 필드로 내림차순 정렬
                currentSortBy = field;
                currentSortOrder = 'desc';
            }
            
            // 데이터 다시 로드
            await loadProperties();
        }
        
        // 필터 핸들러
        function setStatusFilter(value, btn) {
            statusFilter = value;
            // 버튼 active 상태
            document.querySelectorAll('#status-filter-group .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderProperties();
        }
        function setOccupiedFilter(value, btn) {
            occupiedFilter = value;
            document.querySelectorAll('#occupied-filter-group .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderProperties();
        }
        
        // 거래유형 필터
        function setDealTypeFilter(value, btn) {
            dealTypeFilter = value;
            document.querySelectorAll('#deal-type-filter-group .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderProperties();
        }
        
        // 호수 검색 필터
        function filterByRoom(searchValue) {
            roomSearchFilter = searchValue;
            renderProperties();
        }
        
        // 메모 모달 표시
        function showMemoModal(id, memo) {
            currentMemoId = id;
            document.getElementById('memoTextarea').value = memo;
            document.getElementById('memoModal').style.display = 'block';
        }
        
        // 메모 모달 닫기
        function closeMemoModal() {
            document.getElementById('memoModal').style.display = 'none';
            currentMemoId = null;
        }
        
        // 메모 저장
        async function saveMemo() {
            if (!currentMemoId) return;
            
            const memo = document.getElementById('memoTextarea').value;
            
            try {
                const response = await fetch('/api/maeiple/memo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: currentMemoId,
                        memo: memo
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 로컬 상태 업데이트
                    const property = properties.find(p => p.id === currentMemoId);
                    if (property) {
                        property.memo = memo;
                    }
                    closeMemoModal();
                    showSuccess('메모가 저장되었습니다.');
                } else {
                    showError('메모 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('메모 저장에 실패했습니다.');
            }
        }
        
        // 새 매물 행 추가 (대시보드와 같은 방식)
        function addNewPropertyRow() {
            const tbody = document.querySelector('.maeiple-table tbody');
            if (!tbody) return;
            
            // 오늘 날짜 구하기
            const today = new Date().toISOString().split('T')[0];
            
            // 자동 ID 생성 (임시)
            const tempId = Date.now();
            
            const newRow = document.createElement('tr');
            newRow.className = 'new-row';
            newRow.innerHTML = `
                <td class="date-cell" onclick="editDate(null, '${today}', this)">${today}</td>
                <td class="number-cell" onclick="editNumber(null, 'building_number', '', this)">-</td>
                <td class="number-cell" onclick="editNumber(null, 'room_number', '', this)">-</td>
                <td>
                    <button class="status-toggle status-available" onclick="showStatusOptions(null, '거래가능', this)">거래가능</button>
                </td>
                <td class="price-cell" onclick="editPrice(null, 'jeonse_price', '', this)">-</td>
                <td class="price-cell" onclick="editPrice(null, 'deposit', '', this)">-</td>
                <td class="price-cell" onclick="editPrice(null, 'monthly_rent', '', this)">-</td>
                <td class="price-cell" onclick="editPrice(null, 'sale_price', '', this)">-</td>
                <td>
                    <button class="occupied-toggle occupied-no" onclick="toggleOccupied(null, false, this)">X</button>
                </td>
                <td class="phone-cell" onclick="editPhone(null, '', this)">-</td>
                <td class="memo-preview" onclick="showMemoModal(null, '', this)">메모 추가...</td>
                <td>
                    <div class="like-dislike">
                        <div class="like-rating" onclick="showLikeOptions(null, 0, this)">🤍</div>
                    </div>
                </td>
                <td>
                    <div class="like-dislike">
                        <div class="dislike-rating" onclick="showDislikeOptions(null, 0, this)">🤍</div>
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="saveNewProperty(this)">저장</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelNewPropertyRow(this)">취소</button>
                    </div>
                </td>
            `;
            
            tbody.insertBefore(newRow, tbody.firstChild);
        }
        
        // 새 매물 저장
        async function saveNewProperty(button) {
            const row = button.closest('tr');
            
            const propertyData = {};
            
            // 날짜 가져오기
            const dateCell = row.querySelector('.date-cell');
            propertyData.check_date = dateCell.textContent.trim();
            if (propertyData.check_date === '-') propertyData.check_date = '';
            
            // 동/호수 가져오기
            const buildingCell = row.querySelector('td:nth-child(2)');
            propertyData.building_number = buildingCell.textContent.trim();
            if (propertyData.building_number === '-') propertyData.building_number = '';
            
            const roomCell = row.querySelector('td:nth-child(3)');
            propertyData.room_number = roomCell.textContent.trim();
            if (propertyData.room_number === '-') propertyData.room_number = '';
            
            // 상태 정보 가져오기
            const statusBtn = row.querySelector('.status-toggle');
            propertyData.status = statusBtn.textContent.trim();
            
            // 가격 정보 가져오기
            const jeonseCell = row.querySelector('td:nth-child(5)');
            let jeonsePrice = jeonseCell.textContent.trim();
            if (jeonsePrice !== '-') {
                jeonsePrice = jeonsePrice.replace(' 만원', '');
                propertyData.jeonse_price = jeonsePrice;
            }
            
            // 월세 정보 가져오기 (보증금/월세 별도 칸)
            const depositCell = row.querySelector('td:nth-child(6)');
            if (depositCell) {
                let deposit = depositCell.textContent.trim();
                if (deposit !== '-') propertyData.deposit = deposit;
            }
            const monthlyCell = row.querySelector('td:nth-child(7)');
            if (monthlyCell) {
                let monthlyRent = monthlyCell.textContent.trim();
                if (monthlyRent !== '-') propertyData.monthly_rent = monthlyRent.replace(' 만원', '');
            }
            
            // 매매 가격 가져오기 (열 이동으로 인덱스 +1)
            const salePriceCell = row.querySelector('td:nth-child(8)');
            let salePrice = salePriceCell.textContent.trim();
            if (salePrice !== '-') {
                salePrice = salePrice.replace(' 만원', '');
                propertyData.sale_price = salePrice;
            }
            
            // 실거주 여부 가져오기
            const occupiedBtn = row.querySelector('.occupied-toggle');
            propertyData.is_occupied = occupiedBtn.textContent.trim() === 'O';
            
            // 전화번호 가져오기
            const phoneCell = row.querySelector('.phone-cell');
            let phone = phoneCell.textContent.trim();
            if (phone !== '-') {
                propertyData.phone = phone;
            }
            
            // 메모 가져오기
            const memoCell = row.querySelector('.memo-preview');
            let memo = memoCell.textContent.trim();
            if (memo !== '메모 추가...') {
                propertyData.memo = memo;
            }
            
            // 좋아요/싫어요 가져오기
            const likeRating = row.querySelector('.like-rating');
            if (likeRating) {
                const likeText = likeRating.innerHTML;
                propertyData.likes = (likeText.match(/❤️/g) || []).length;
            }
            
            const dislikeRating = row.querySelector('.dislike-rating');
            if (dislikeRating) {
                const dislikeText = dislikeRating.innerHTML;
                propertyData.dislikes = (dislikeText.match(/👎/g) || []).length;
            }
            
            // 필수 항목 검증
            if (!propertyData.check_date || !propertyData.building_number || !propertyData.room_number) {
                showError('확인날짜, 동, 호수는 필수 항목입니다.');
                return;
            }
            
            try {
                const response = await fetch('/api/maeiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        check_date: propertyData.check_date,
                        building_number: parseInt(propertyData.building_number),
                        room_number: parseInt(propertyData.room_number),
                        status: propertyData.status,
                        jeonse_price: propertyData.jeonse_price ? parseInt(propertyData.jeonse_price) : null,
                        monthly_rent: propertyData.monthly_rent ? parseInt(propertyData.monthly_rent) : null,
                        sale_price: propertyData.sale_price ? parseInt(propertyData.sale_price) : null,
                        is_occupied: propertyData.is_occupied,
                        phone: propertyData.phone,
                        memo: propertyData.memo || '',
                        likes: propertyData.likes,
                        dislikes: propertyData.dislikes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('새 매물이 추가되었습니다.');
                    
                    // 새 매물을 로컬 배열에 추가
                    const newProperty = {
                        id: data.id,
                        check_date: propertyData.check_date,
                        building_number: parseInt(propertyData.building_number),
                        room_number: parseInt(propertyData.room_number),
                        status: propertyData.status,
                        jeonse_price: propertyData.jeonse_price ? parseInt(propertyData.jeonse_price) : null,
                        monthly_rent: propertyData.monthly_rent ? parseInt(propertyData.monthly_rent) : null,
                        sale_price: propertyData.sale_price ? parseInt(propertyData.sale_price) : null,
                        is_occupied: propertyData.is_occupied,
                        phone: propertyData.phone,
                        memo: propertyData.memo || '',
                        likes: propertyData.likes,
                        dislikes: propertyData.dislikes
                    };
                    
                    properties.unshift(newProperty);
                    
                    // 행을 정상 행으로 변환
                    row.className = '';
                    row.removeChild(row.querySelector('.action-buttons'));
                    
                    // 성공 메시지 표시
                    showSuccess('매물이 성공적으로 추가되었습니다.');
                } else {
                    showError('매물 추가에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('매물 추가에 실패했습니다.');
            }
        }
        
        // 새 매물 행 취소
        function cancelNewPropertyRow(button) {
            const row = button.closest('tr');
            row.remove();
        }
        
        // 매물 셀 편집
        function editPropertyCell(cell) {
            const field = cell.dataset.field;
            const currentValue = cell.textContent.trim();
            
            if (field === 'check_date') {
                const input = document.createElement('input');
                input.type = 'date';
                input.value = currentValue === '-' ? '' : currentValue;
                input.className = 'input-field input-small';
                
                input.onblur = function() {
                    cell.textContent = this.value || '-';
                    updatePropertyField(cell);
                };
                
                input.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                };
                
                cell.textContent = '';
                cell.appendChild(input);
                input.focus();
            } else if (field === 'phone') {
                const input = document.createElement('input');
                input.type = 'tel';
                input.value = currentValue === '-' ? '' : currentValue;
                input.className = 'input-field';
                input.placeholder = '000-0000-0000';
                
                input.onblur = function() {
                    cell.textContent = this.value || '-';
                    updatePropertyField(cell);
                };
                
                input.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                };
                
                cell.textContent = '';
                cell.appendChild(input);
                input.focus();
            } else {
                const input = document.createElement('input');
                input.type = 'number';
                input.value = currentValue === '-' ? '' : currentValue;
                input.className = 'input-field input-small';
                
                input.onblur = function() {
                    cell.textContent = this.value || '-';
                    updatePropertyField(cell);
                };
                
                input.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                };
                
                cell.textContent = '';
                cell.appendChild(input);
                input.focus();
            }
        }
        
        // 매물 상태 편집
        function editPropertyStatus(button) {
            const currentStatus = button.textContent.trim();
            const newStatus = currentStatus === '거래가능' ? '계약완료' : '거래가능';
            
            button.textContent = newStatus;
            button.className = `status-toggle ${newStatus === '계약완료' ? 'status-completed' : 'status-trading'}`;
            
            // 상태 업데이트
            const row = button.closest('tr');
            const id = row.dataset.propertyId;
            if (id) {
                updatePropertyField(button, 'status', newStatus);
            }
        }
        
        // 매물 실거주 여부 편집
        function editPropertyOccupied(button) {
            const currentOccupied = button.textContent.trim();
            const newOccupied = currentOccupied === 'O' ? 'X' : 'O';
            
            button.textContent = newOccupied;
            button.className = `occupied-toggle ${newOccupied === 'O' ? 'occupied-yes' : 'occupied-no'}`;
            
            // 상태 업데이트
            const row = button.closest('tr');
            const id = row.dataset.propertyId;
            if (id) {
                updatePropertyField(button, 'is_occupied', newOccupied === 'O');
            }
        }
        
        // 매물 좋아요/싫어요 편집
        function editPropertyLikes(button, currentLikes, increment) {
            const countSpan = button.nextElementSibling;
            const newLikes = Math.min(5, Math.max(0, currentLikes + increment));
            countSpan.textContent = newLikes;
            
            // 상태 업데이트
            const row = button.closest('tr');
            const id = row.dataset.propertyId;
            if (id) {
                updatePropertyField(button, 'likes', newLikes);
            }
        }
        
        function editPropertyDislikes(button, currentDislikes, increment) {
            const countSpan = button.nextElementSibling;
            const newDislikes = Math.min(5, Math.max(0, currentDislikes + increment));
            countSpan.textContent = newDislikes;
            
            // 상태 업데이트
            const row = button.closest('tr');
            const id = row.dataset.propertyId;
            if (id) {
                updatePropertyField(button, 'dislikes', newDislikes);
            }
        }
        
        // 매물 메모 편집
        function editPropertyMemo(button) {
            const row = button.closest('tr');
            const id = row.dataset.propertyId;
            
            if (id) {
                // 기존 매물의 메모 편집
                const memo = properties.find(p => p.id == id)?.memo || '';
                showMemoModal(id, memo);
            } else {
                // 새 매물의 메모 편집
                const memo = prompt('메모를 입력하세요:');
                if (memo !== null) {
                    // 새 매물의 메모 필드 업데이트
                    const memoCell = row.querySelector('.memo-icon');
                    memoCell.textContent = memo ? '📝' : '📝';
                    memoCell.title = memo || '메모 없음';
                }
            }
        }
        
        // 매물 필드 업데이트
        function updatePropertyField(element, field, value) {
            const row = element.closest('tr');
            const id = row.dataset.propertyId;
            
            if (id) {
                // 기존 매물 업데이트
                updateField(id, field, value);
            }
        }
        
        // 날짜 편집 (이쁜 달력)
        function editDate(id, currentValue, cell) {
            // 기존 내용 저장
            const originalContent = cell.innerHTML;
            
            // 날짜 입력 필드 생성
            const input = document.createElement('input');
            input.type = 'date';
            input.value = currentValue || '';
            input.className = 'date-picker';
            input.style.width = '100%';
            input.style.padding = '8px';
            input.style.border = '2px solid #3b82f6';
            input.style.borderRadius = '6px';
            input.style.outline = 'none';
            
            // 셀 내용 교체
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // 포커스 및 달력 바로 열기 (지원되는 브라우저)
            input.focus();
            try {
                if (typeof input.showPicker === 'function') {
                    // 입력 필드가 DOM에 붙고 포커스된 직후 호출해야 열림
                    setTimeout(() => {
                        try { input.showPicker(); } catch (e) {}
                    }, 0);
                }
            } catch (e) {}
            
            // 이벤트 핸들러
            function handleChange() {
                const newValue = input.value;
                
                // 원래 내용으로 복원
                cell.innerHTML = newValue || '-';
                
                // 값이 변경된 경우에만 업데이트
                if (newValue !== currentValue && newValue) {
                    if (id) {
                        updateField(id, 'check_date', newValue);
                    } else {
                        // 새 행인 경우 셀 값만 업데이트
                        cell.textContent = newValue;
                    }
                } else if (!newValue) {
                    cell.textContent = currentValue || '-';
                }
                
                // 이벤트 리스너 제거
                document.removeEventListener('click', handleOutsideClick);
            }
            
            function handleOutsideClick(e) {
                if (e.target !== input) {
                    handleChange();
                }
            }
            
            // 이벤트 리스너 등록
            input.addEventListener('change', handleChange);
            input.addEventListener('blur', handleChange);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleChange();
                }
            });
            
            // 외부 클릭 감지 (다음 클릭부터)
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 0);
        }
        
        // 숫자 편집 (동/호수)
        function editNumber(id, field, currentValue, cell) {
            // 기존 내용 저장
            const originalContent = cell.innerHTML;
            
            // 입력 필드 생성
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue || '';
            input.className = 'number-input';
            input.style.width = '100%';
            input.style.padding = '8px';
            input.style.border = '2px solid #3b82f6';
            input.style.borderRadius = '6px';
            input.style.outline = 'none';
            input.min = '1';
            
            // 셀 내용 교체
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // 포커스
            input.focus();
            
            // 이벤트 핸들러
            function handleChange() {
                const newValue = input.value;
                
                // 원래 내용으로 복원
                cell.innerHTML = newValue || '-';
                
                // 값이 변경된 경우에만 업데이트
                if (newValue !== currentValue) {
                    if (id) {
                        updateField(id, field, newValue);
                    } else {
                        // 새 행인 경우 셀 값만 업데이트
                        cell.textContent = newValue;
                    }
                } else if (!newValue) {
                    cell.textContent = currentValue || '-';
                }
                
                // 이벤트 리스너 제거
                document.removeEventListener('click', handleOutsideClick);
            }
            
            function handleOutsideClick(e) {
                if (e.target !== input) {
                    handleChange();
                }
            }
            
            // 이벤트 리스너 등록
            input.addEventListener('change', handleChange);
            input.addEventListener('blur', handleChange);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleChange();
                }
            });
            
            // 외부 클릭 감지 (다음 클릭부터)
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 0);
        }
        
            // 가격 편집 (전세/월세보증금/월세/매매)
        function editPrice(id, field, currentValue, cell) {
            // 기존 내용 저장
            const originalContent = cell.innerHTML;
            
            // 입력 필드 생성
            const input = document.createElement('input');
            input.type = 'text';
            const rawInit = (currentValue || '').toString().replace(/[^\d]/g, '');
            input.value = rawInit ? formatNumber(rawInit) : '';
            input.className = 'price-input';
            input.style.width = '100%';
            input.style.padding = '8px';
            input.style.border = '2px solid #3b82f6';
            input.style.borderRadius = '6px';
            input.style.outline = 'none';
            input.placeholder = '만원 단위';
            
            // 셀 내용 교체
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // 포커스
            input.focus();

                // 입력 시 천단위 콤마 마스킹
                input.addEventListener('input', function() {
                    const before = this.value;
                    const raw = before.replace(/[^\d]/g, '');
                    const formatted = raw ? formatNumber(raw) : '';
                    this.value = formatted;
                });
            
            // 이벤트 핸들러
            function handleChange() {
                const newValueRaw = input.value.replace(/[^\d]/g, '');
                
                // 원래 내용으로 복원
                if (newValueRaw) {
                    if (field === 'deposit') {
                        cell.innerHTML = formatNumber(newValueRaw) + ' 만원';
                    } else {
                        cell.innerHTML = formatNumber(newValueRaw) + ' 만원';
                    }
                } else {
                    cell.innerHTML = '-';
                }
                
                // 값이 변경된 경우에만 업데이트
                const currentNumeric = (currentValue || '').toString().replace(/[^\d]/g, '');
                if (newValueRaw !== currentNumeric) {
                    if (id) {
                        updateField(id, field, newValueRaw || null);
                    }
                }
                
                // 이벤트 리스너 제거
                document.removeEventListener('click', handleOutsideClick);
            }
            
            function handleOutsideClick(e) {
                if (e.target !== input) {
                    handleChange();
                }
            }
            
            // 이벤트 리스너 등록
            input.addEventListener('change', handleChange);
            input.addEventListener('blur', handleChange);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleChange();
                }
            });
            
            // 외부 클릭 감지 (다음 클릭부터)
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 0);
        }
        
        // 전화번호 편집
        function editPhone(id, currentValue, cell) {
            // 기존 내용 저장
            const originalContent = cell.innerHTML;
            
            // 입력 필드 생성
            const input = document.createElement('input');
            input.type = 'tel';
            input.value = currentValue || '';
            input.className = 'phone-input';
            input.style.width = '100%';
            input.style.padding = '8px';
            input.style.border = '2px solid #3b82f6';
            input.style.borderRadius = '6px';
            input.style.outline = 'none';
            input.placeholder = '000-0000-0000';
            input.maxLength = 13;
            
            // 셀 내용 교체
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // 포커스
            input.focus();
            
            // 전화번호 포맷팅 함수
            function formatPhoneNumber(value) {
                if (!value) return '';
                
                // 숫자만 추출
                const numbers = value.replace(/\D/g, '');
                
                // 포맷팅
                if (numbers.length <= 3) {
                    return numbers;
                } else if (numbers.length <= 7) {
                    return numbers.slice(0, 3) + '-' + numbers.slice(3);
                } else {
                    return numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + '-' + numbers.slice(7, 11);
                }
            }
            
            // 입력 시 자동 포맷팅
            input.addEventListener('input', function() {
                const formatted = formatPhoneNumber(input.value);
                input.value = formatted;
            });
            
            // 이벤트 핸들러
            function handleChange() {
                const newValue = input.value;
                
                // 원래 내용으로 복원
                cell.innerHTML = newValue || '-';
                
                // 값이 변경된 경우에만 업데이트
                if (newValue !== currentValue) {
                    if (id) {
                        updateField(id, 'phone', newValue);
                    }
                }
                
                // 이벤트 리스너 제거
                document.removeEventListener('click', handleOutsideClick);
            }
            
            function handleOutsideClick(e) {
                if (e.target !== input) {
                    handleChange();
                }
            }
            
            // 이벤트 리스너 등록
            input.addEventListener('change', handleChange);
            input.addEventListener('blur', handleChange);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleChange();
                }
            });
            
            // 외부 클릭 감지 (다음 클릭부터)
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 0);
        }
        
        // 현황 옵션 표시
        function showStatusOptions(id, currentStatus, button) {
            // 기존 팝업 제거
            removeAllPopups();
            
            // 팝업 메뉴 생성
            const popup = document.createElement('div');
            popup.className = 'popup-menu';
            popup.style.position = 'absolute';
            popup.style.left = '0';
            popup.style.top = '100%';
            popup.style.zIndex = '1000';
            
            // 옵션 추가
            const statuses = ['거래가능', '계약완료', '보류', '부재'];
            statuses.forEach(status => {
                const item = document.createElement('div');
                item.className = 'popup-menu-item' + (status === currentStatus ? ' active' : '');
                item.textContent = status;
                
                item.addEventListener('click', function() {
                    // 버튼 업데이트
                    button.textContent = status;
                    const statusClass = status === '계약완료' ? 'status-completed' : status === '보류' ? 'status-hold' : status === '부재' ? 'status-absent' : 'status-available';
                    button.className = `status-toggle ${statusClass}`;
                    
                    // 서버 업데이트
                    if (id) {
                        updateField(id, 'status', status);
                    }
                    
                    // 팝업 닫기
                    document.body.removeChild(popup);
                });
                
                popup.appendChild(item);
            });
            
            // 팝업 위치 조정
            const rect = button.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY) + 'px';
            popup.style.left = (rect.left + window.scrollX) + 'px';
            popup.style.minWidth = rect.width + 'px';
            
            // 문서에 추가
            document.body.appendChild(popup);
            
            // 외부 클릭 시 닫기
            setTimeout(() => {
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && e.target !== button) {
                        if (document.body.contains(popup)) {
                            document.body.removeChild(popup);
                        }
                        document.removeEventListener('click', closePopup);
                    }
                });
            }, 0);
        }
        
        // 좋아요 옵션 표시
        function showLikeOptions(id, currentValue, element) {
            // 기존 팝업 제거
            removeAllPopups();
            
            // 팝업 생성
            const popup = document.createElement('div');
            popup.className = 'rating-popup';
            popup.style.position = 'absolute';
            popup.style.background = 'white';
            popup.style.border = '1px solid #e2e8f0';
            popup.style.borderRadius = '8px';
            popup.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            popup.style.zIndex = '1000';
            
            // 옵션 추가 (0-5)
            for (let i = 0; i <= 5; i++) {
                const option = document.createElement('div');
                option.className = 'rating-option' + (i === currentValue ? ' active' : '');
                option.innerHTML = i === 0 ? '🤍' : '❤️'.repeat(i);
                option.style.padding = '8px';
                option.style.cursor = 'pointer';
                option.style.borderRadius = '4px';
                
                if (i === currentValue) {
                    option.style.background = '#e0f2fe';
                }
                
                option.addEventListener('mouseenter', function() {
                    this.style.background = '#f0f9ff';
                });
                
                option.addEventListener('mouseleave', function() {
                    if (i !== currentValue) {
                        this.style.background = '';
                    } else {
                        this.style.background = '#e0f2fe';
                    }
                });
                
                option.addEventListener('click', function() {
                    // 엘리먼트 업데이트
                    element.innerHTML = i === 0 ? '🤍' : '❤️'.repeat(i);
                    
                    // 서버 업데이트
                    if (id) {
                        updateField(id, 'likes', i);
                    }
                    
                    // 팝업 닫기
                    document.body.removeChild(popup);
                });
                
                popup.appendChild(option);
            }
            
            // 팝업 위치 조정
            const rect = element.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY) + 'px';
            popup.style.left = (rect.left + window.scrollX) + 'px';
            
            // 문서에 추가
            document.body.appendChild(popup);
            
            // 외부 클릭 시 닫기
            setTimeout(() => {
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && e.target !== element) {
                        if (document.body.contains(popup)) {
                            document.body.removeChild(popup);
                        }
                        document.removeEventListener('click', closePopup);
                    }
                });
            }, 0);
        }
        
        // 싫어요 옵션 표시
        function showDislikeOptions(id, currentValue, element) {
            // 기존 팝업 제거
            removeAllPopups();
            
            // 팝업 생성
            const popup = document.createElement('div');
            popup.className = 'rating-popup';
            popup.style.position = 'absolute';
            popup.style.background = 'white';
            popup.style.border = '1px solid #e2e8f0';
            popup.style.borderRadius = '8px';
            popup.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            popup.style.zIndex = '1000';
            
            // 옵션 추가 (0-5)
            for (let i = 0; i <= 5; i++) {
                const option = document.createElement('div');
                option.className = 'rating-option' + (i === currentValue ? ' active' : '');
                option.innerHTML = i === 0 ? '🤍' : '👎'.repeat(i);
                option.style.padding = '8px';
                option.style.cursor = 'pointer';
                option.style.borderRadius = '4px';
                
                if (i === currentValue) {
                    option.style.background = '#e0f2fe';
                }
                
                option.addEventListener('mouseenter', function() {
                    this.style.background = '#f0f9ff';
                });
                
                option.addEventListener('mouseleave', function() {
                    if (i !== currentValue) {
                        this.style.background = '';
                    } else {
                        this.style.background = '#e0f2fe';
                    }
                });
                
                option.addEventListener('click', function() {
                    // 엘리먼트 업데이트
                    element.innerHTML = i === 0 ? '🤍' : '👎'.repeat(i);
                    
                    // 서버 업데이트
                    if (id) {
                        updateField(id, 'dislikes', i);
                    }
                    
                    // 팝업 닫기
                    document.body.removeChild(popup);
                });
                
                popup.appendChild(option);
            }
            
            // 팝업 위치 조정
            const rect = element.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY) + 'px';
            popup.style.left = (rect.left + window.scrollX) + 'px';
            
            // 문서에 추가
            document.body.appendChild(popup);
            
            // 외부 클릭 시 닫기
            setTimeout(() => {
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && e.target !== element) {
                        if (document.body.contains(popup)) {
                            document.body.removeChild(popup);
                        }
                        document.removeEventListener('click', closePopup);
                    }
                });
            }, 0);
        }
        
        // 모든 팝업 제거
        function removeAllPopups() {
            const popups = document.querySelectorAll('.popup-menu, .rating-popup');
            popups.forEach(popup => {
                if (document.body.contains(popup)) {
                    document.body.removeChild(popup);
                }
            });
        }
        

        
        // 성공 메시지 표시
        function showSuccess(message) {
            alert(message); // 간단한 알림으로 대체
        }
        
        // 에러 메시지 표시
        function showError(message) {
            alert(message); // 간단한 알림으로 대체
        }
        
        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const memoModal = document.getElementById('memoModal');
            const addModal = document.getElementById('addModal');
            
            if (event.target === memoModal) {
                closeMemoModal();
            }
            if (event.target === addModal) {
                closeAddModal();
            }
        }
    </script>
</body>
</html>
