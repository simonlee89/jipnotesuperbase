<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ë©”ì´í”Œê´€ë¦¬</title>
    <style>
      body { 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        margin: 0;
        padding: 24px;
        background: #f8fafc;
        color: #1a202c;
        line-height: 1.6;
      }
      
      .header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 24px;
      }
      
      h1 { 
        margin: 0 0 8px 0;
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
      }
      
      .muted { 
        color: #64748b; 
        font-size: 14px;
        margin: 0;
      }
      
      .form-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 24px;
      }
      
      .section-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 20px 0;
        color: #1e293b;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
      }
      
      .form-group.full-width {
        grid-column: 1 / -1;
      }
      
      label { 
        font-weight: 600;
        margin-bottom: 6px;
        color: #374151;
        font-size: 14px;
      }
      
      input, select, textarea { 
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }
      
      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      button { 
        padding: 12px 24px;
        border: 0;
        border-radius: 8px;
        background: #6366f1;
        color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: background-color 0.2s ease;
      }
      
      button:hover {
        background: #5855eb;
      }
      
      .phone-input {
        position: relative;
      }
      
      .phone-input input {
        padding-left: 50px;
      }
      
      .phone-prefix {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        font-size: 14px;
        pointer-events: none;
      }
      
      .table-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
      }
      
      .table-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      table { 
        width: 100%;
        border-collapse: collapse;
      }
      
      th, td { 
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 16px;
        text-align: left;
      }
      
      th { 
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      td {
        font-size: 14px;
      }
      
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .status-ê±°ë˜ê°€ëŠ¥ {
        background: #d1fae5;
        color: #065f46;
      }
      
      .status-ê³„ì•½ì™„ë£Œ {
        background: #dbeafe;
        color: #1e40af;
      }
      
      .status-ë³´ë¥˜ {
        background: #fef3c7;
        color: #92400e;
      }
      
      .status-ë¶€ì¬ {
        background: #fee2e2;
        color: #991b1b;
      }
      
      .editable-cell {
        cursor: pointer;
        transition: background-color 0.1s ease; /* ë” ë¹ ë¥¸ ì „í™˜ */
      }
      
      .editable-cell:hover {
        background-color: #f3f4f6;
        transform: scale(1.02); /* í˜¸ë²„ ì‹œ ì‚´ì§ í™•ëŒ€ */
      }
      
      .editing-cell {
        background-color: #fef3c7;
        box-shadow: 0 0 0 2px #6366f1; /* í¸ì§‘ ì¤‘ ê°•ì¡° */
      }
      
      .updating {
        opacity: 0.7;
        pointer-events: none; /* ì—…ë°ì´íŠ¸ ì¤‘ì—ëŠ” í´ë¦­ ë°©ì§€ */
        position: relative;
      }
      
      .updating::after {
        content: 'ì €ì¥ ì¤‘...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(99, 102, 241, 0.9);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        z-index: 1000;
      }
      
      .cell-select {
        width: 100%;
        padding: 6px 8px;
        border: 2px solid #6366f1;
        border-radius: 4px;
        font-size: 12px;
        background: white;
        cursor: pointer;
        outline: none;
      }
      
      .cell-select:focus {
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }
      
      .heart-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .action-btn {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .action-btn:hover {
        border-color: #6366f1;
        color: #6366f1;
      }
      
      .phone-display {
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 13px;
      }
      
      .empty-state {
        text-align: center;
        color: #6b7280;
        padding: 40px;
        font-style: italic;
      }
      
      .loading {
        text-align: center;
        color: #6b7280;
        padding: 20px;
      }
      
      @media (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
        
        .table-section {
          overflow-x: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ë©”ì´í”Œê´€ë¦¬</h1>
      <p class="muted">ì•ˆë…•í•˜ì„¸ìš”, <strong>{{ employee_name }}</strong> ë‹˜</p>
    </div>

    <div class="form-section">
      <h2 class="section-title">ìƒˆ ë§¤ë¬¼ ì¶”ê°€</h2>
      <form id="property-form">
        <div class="form-grid">
          <div class="form-group">
            <label>í™•ì¸ ë‚ ì§œ</label>
            <input type="date" name="check_date" required />
          </div>
          
          <div class="form-group">
            <label>ë™</label>
            <input type="number" name="building_number" required placeholder="ì˜ˆ: 101" />
          </div>
          
          <div class="form-group">
            <label>í˜¸ìˆ˜</label>
            <input type="number" name="room_number" required placeholder="ì˜ˆ: 1001" />
          </div>
          
          <div class="form-group">
            <label>í˜„í™©</label>
            <select name="status">
              <option value="ê±°ë˜ê°€ëŠ¥">ê±°ë˜ê°€ëŠ¥</option>
              <option value="ê³„ì•½ì™„ë£Œ">ê³„ì•½ì™„ë£Œ</option>
              <option value="ë³´ë¥˜">ë³´ë¥˜</option>
              <option value="ë¶€ì¬">ë¶€ì¬</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>ì „ì„¸ê°€ (ë§Œì›)</label>
            <input type="number" name="jeonse_price" placeholder="ì˜ˆ: 5000" />
          </div>
          
          <div class="form-group">
            <label>ì›”ì„¸ (ë§Œì›)</label>
            <input type="number" name="monthly_rent" placeholder="ì˜ˆ: 50" />
          </div>
          
          <div class="form-group">
            <label>ë§¤ë§¤ê°€ (ë§Œì›)</label>
            <input type="number" name="sale_price" placeholder="ì˜ˆ: 80000" />
          </div>
          
          <div class="form-group">
            <label>ì ìœ  ì—¬ë¶€</label>
            <select name="is_occupied">
              <option value="false">ë¹ˆì§‘</option>
              <option value="true">ì…ì£¼ì¤‘</option>
            </select>
          </div>
          
          <div class="form-group phone-input">
            <label>ì—°ë½ì²˜</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; color: #6b7280;">010-</span>
              <input type="tel" name="phone" placeholder="0000-0000" maxlength="9" style="flex: 1; font-family: monospace; letter-spacing: 0.5px;" />
            </div>
          </div>
          
          <div class="form-group full-width">
            <label>ë©”ëª¨</label>
            <textarea name="memo" rows="3" placeholder="ë§¤ë¬¼ì— ëŒ€í•œ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          </div>
        </div>
        
        <button type="submit">ë§¤ë¬¼ ì¶”ê°€</button>
      </form>
    </div>

    <div class="table-section">
      <div class="table-header">
        <h2 class="section-title">ë‚´ ë§¤ë¬¼ ëª©ë¡</h2>
      </div>
      <div style="overflow-x: auto;">
        <table id="properties-table">
          <thead>
            <tr>
              <th>ë‚ ì§œ</th>
              <th>ìœ„ì¹˜</th>
              <th>í˜„í™©</th>
              <th>ì „ì„¸/ì›”ì„¸/ë§¤ë§¤</th>
              <th>ì—°ë½ì²˜</th>
              <th>ì¢‹ì•„ìš”/ì‹«ì–´ìš”</th>
              <th>ë©”ëª¨</th>
              <th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="8" class="loading">ë§¤ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
      document.querySelector('input[name="phone"]').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 4) {
          value = value.slice(0, 4) + '-' + value.slice(4, 8);
        }
        if (value.length > 9) {
          value = value.slice(0, 9);
        }
        e.target.value = value;
      });

      // ë§¤ë¬¼ ëª©ë¡ ë¡œë“œ
      async function loadMyProperties() {
        try {
          const res = await fetch('/api/employee/maeiple?sort_by=check_date&sort_order=desc&page=1&per_page=50');
          const data = await res.json();
          const tbody = document.querySelector('#properties-table tbody');
          
          if (data.success && data.properties && data.properties.length > 0) {
            const rows = data.properties.map(p => `
              <tr data-id="${p.id}">
                <td>${p.check_date || '-'}</td>
                <td>${p.building_number || '-'}ë™ ${p.room_number || '-'}í˜¸</td>
                                <td class="editable-cell" data-field="status" data-type="select" data-id="${p.id}" onclick="editMaeipleCell(this)">
                  <span class="status-badge status-${p.status || 'ê±°ë˜ê°€ëŠ¥'}">${p.status || 'ê±°ë˜ê°€ëŠ¥'}</span>
                </td>
                <td>
                  <div style="font-size: 12px; line-height: 1.4;">
                    ${p.jeonse_price ? `ì „ì„¸: ${p.jeonse_price}ë§Œ` : ''}
                    ${p.monthly_rent ? `${p.jeonse_price ? '<br>' : ''}ì›”ì„¸: ${p.monthly_rent}ë§Œ` : ''}
                    ${p.sale_price ? `${p.jeonse_price || p.monthly_rent ? '<br>' : ''}ë§¤ë§¤: ${p.sale_price}ë§Œ` : ''}
                    ${!p.jeonse_price && !p.monthly_rent && !p.sale_price ? '-' : ''}
                  </div>
                </td>
                <td class="phone-display" style="font-family: monospace; letter-spacing: 0.5px;">${formatPhone(p.phone) || '-'}</td>
                <td>
                  <div class="heart-container" style="display: flex; align-items: center; gap: 8px;">
                    <div class="editable-cell" data-field="likes" data-type="select" data-id="${p.id}" onclick="editMaeipleCell(this)" 
                         style="display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;">
                      <span style="font-size: 18px; color: ${p.likes > 0 ? '#ef4444' : '#d1d5db'};">â™¥</span>
                      <span style="font-size: 12px; color: #6b7280;">${p.likes || 0}</span>
                    </div>
                    <div class="editable-cell" data-field="dislikes" data-type="select" data-id="${p.id}" onclick="editMaeipleCell(this)" 
                         style="display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;">
                      <span style="font-size: 18px; color: ${p.dislikes > 0 ? '#3b82f6' : '#d1d5db'}; transform: rotate(180deg);">â™¥</span>
                      <span style="font-size: 12px; color: #6b7280;">${p.dislikes || 0}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; color: #3b82f6;" 
                       title="${p.memo || ''}" onclick="showMemoPopup(${p.id}, '${(p.memo || '').replace(/'/g, "\\'")}')">
                    ${p.memo || 'ë©”ëª¨ ì¶”ê°€'}
                  </div>
                </td>
                <td>
                  <button class="action-btn" onclick="editProperty(${p.id})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ìˆ˜ì •</button>
                </td>
              </tr>
            `).join('');
            tbody.innerHTML = rows;
          } else {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state">ë“±ë¡ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          }
        } catch (error) {
          console.error('ë§¤ë¬¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          document.querySelector('#properties-table tbody').innerHTML = 
            '<tr><td colspan="8" class="empty-state">ë§¤ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
      }

      // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
      function formatPhone(phone) {
        if (!phone) return '';
        const cleaned = phone.replace(/\D/g, '');
        if (cleaned.startsWith('010')) {
          if (cleaned.length === 11) {
            return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
          }
        }
        return phone;
      }



      // ì¸ë¼ì¸ í¸ì§‘ í•¨ìˆ˜ (í˜„í™© í•„ë“œë§Œ)
      function editMaeipleCell(cell) {
        if (cell.classList.contains('editing-cell')) return;
        
        const field = cell.dataset.field;
        const type = cell.dataset.type;
        const propertyId = cell.dataset.id;
        
        console.log('ì…€ í¸ì§‘ ì‹œì‘:', field, propertyId);
        
        let currentValue;
        if (field === 'status') {
          const badge = cell.querySelector('.status-badge');
          currentValue = badge ? badge.textContent.trim() : 'ê±°ë˜ê°€ëŠ¥';
        } else if (field === 'likes' || field === 'dislikes') {
          const countSpan = cell.querySelector('span:last-child');
          currentValue = countSpan ? countSpan.textContent.trim() : '0';
        } else {
          currentValue = cell.textContent.trim();
        }
        // ì›ë˜ ê°’ ì €ì¥ (ì‹¤íŒ¨ ì‹œ ë³µêµ¬ìš©)
        cell.dataset.originalValue = currentValue;
        
        cell.classList.add('editing-cell');
        
        let inputElement;
        if (type === 'select' && field === 'status') {
          inputElement = document.createElement('select');
          inputElement.className = 'cell-select';
          inputElement.style.cssText = `
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #6366f1;
            border-radius: 4px;
            font-size: 12px;
          background: white;
            cursor: pointer;
          `;
          inputElement.innerHTML = `
            <option value="ê±°ë˜ê°€ëŠ¥" ${currentValue === 'ê±°ë˜ê°€ëŠ¥' ? 'selected' : ''}>ğŸ”„ ê±°ë˜ê°€ëŠ¥</option>
            <option value="ê³„ì•½ì™„ë£Œ" ${currentValue === 'ê³„ì•½ì™„ë£Œ' ? 'selected' : ''}>âœ… ê³„ì•½ì™„ë£Œ</option>
            <option value="ë³´ë¥˜" ${currentValue === 'ë³´ë¥˜' ? 'selected' : ''}>â¸ï¸ ë³´ë¥˜</option>
            <option value="ë¶€ì¬" ${currentValue === 'ë¶€ì¬' ? 'selected' : ''}>âŒ ë¶€ì¬</option>
          `;
        } else if (type === 'select' && (field === 'likes' || field === 'dislikes')) {
          inputElement = document.createElement('select');
          inputElement.className = 'cell-select';
          inputElement.style.cssText = `
          width: 100%;
            padding: 6px 8px;
            border: 2px solid #6366f1;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            cursor: pointer;
          `;
          
          let options = '';
          for (let i = 0; i <= 5; i++) {
            const selected = i == currentValue ? 'selected' : '';
            options += `<option value="${i}" ${selected}>${i === 0 ? 'ì—†ìŒ' : i + ' â™¥'}</option>`;
          }
          inputElement.innerHTML = options;
        }

        
        cell.innerHTML = '';
        cell.appendChild(inputElement);
        inputElement.focus();
        
        // ì—”í„°í‚¤ ë˜ëŠ” í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì €ì¥ (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
        let isProcessingSave = false;
        const saveCell = () => {
          if (isProcessingSave) {
            console.log('ì´ë¯¸ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ í˜¸ì¶œ ë¬´ì‹œ.');
            return;
          }
          
          isProcessingSave = true;
          const newValue = inputElement.value.trim();
          console.log('ì…€ ì €ì¥:', field, newValue);
          
          updateMaeipleField(propertyId, field, newValue, cell).finally(() => {
            isProcessingSave = false;
          });
        };
        
        inputElement.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveCell();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelMaeipleCellEdit(cell, currentValue);
          }
        });
        
        // select ìš”ì†Œì™€ ì¼ë°˜ input ìš”ì†Œ êµ¬ë¶„ ì²˜ë¦¬
        if (inputElement.tagName === 'SELECT') {
          inputElement.addEventListener('change', () => {
            console.log('select ë³€ê²½ ì¦‰ì‹œ ì €ì¥');
            saveCell();
          });
        } else {
          inputElement.addEventListener('blur', saveCell);
        }
      }
      
      // ì…€ í¸ì§‘ ì·¨ì†Œ
      function cancelMaeipleCellEdit(cell, originalValue) {
        cell.classList.remove('editing-cell');
        
        const field = cell.dataset.field;
        
        if (field === 'status') {
          // ê¸°ì¡´ badgeë¥¼ ì°¾ì•„ì„œ í´ë˜ìŠ¤ì™€ í…ìŠ¤íŠ¸ë§Œ ë³µêµ¬ (í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€)
          const badge = cell.querySelector('.status-badge');
          if (badge) {
            const statusClass = originalValue === 'ê³„ì•½ì™„ë£Œ' ? 'status-ê³„ì•½ì™„ë£Œ' : 
                               originalValue === 'ë³´ë¥˜' ? 'status-ë³´ë¥˜' : 
                               originalValue === 'ë¶€ì¬' ? 'status-ë¶€ì¬' : 'status-ê±°ë˜ê°€ëŠ¥';
            badge.className = `status-badge ${statusClass}`;
            badge.textContent = originalValue;
          }
        } else if (field === 'likes') {
          // í•˜íŠ¸ ìƒ‰ìƒê³¼ ìˆ«ìë§Œ ë³µêµ¬ (í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€)
          const heartSpan = cell.querySelector('span:first-child');
          const countSpan = cell.querySelector('span:last-child');
          if (heartSpan && countSpan) {
            heartSpan.style.color = originalValue > 0 ? '#ef4444' : '#d1d5db';
            countSpan.textContent = originalValue;
          }
        } else if (field === 'dislikes') {
          // í•˜íŠ¸ ìƒ‰ìƒê³¼ ìˆ«ìë§Œ ë³µêµ¬ (í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€)
          const heartSpan = cell.querySelector('span:first-child');
          const countSpan = cell.querySelector('span:last-child');
          if (heartSpan && countSpan) {
            heartSpan.style.color = originalValue > 0 ? '#3b82f6' : '#d1d5db';
            countSpan.textContent = originalValue;
          }
        } else {
          cell.textContent = originalValue;
        }
      }
      
      // ë¡œì»¬ ë°ì´í„° ì €ì¥ì†Œ (ì›¹ ë©”ëª¨ë¦¬)
      const localData = new Map();

      // ë©”ì´í”Œ í•„ë“œ ì—…ë°ì´íŠ¸ - ì›¹ì—ì„œ ì¦‰ì‹œ ì €ì¥ í›„ ì„œë²„ ë™ê¸°í™”
      async function updateMaeipleField(propertyId, field, value, cell) {
        console.log('ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸:', propertyId, field, value);
        
        // í¸ì§‘ ìƒíƒœ í•´ì œ
        cell.classList.remove('editing-cell');

        // likes/dislikesëŠ” ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜
        let payloadValue = value;
        if (field === 'likes' || field === 'dislikes') {
          payloadValue = parseInt(value, 10);
          if (Number.isNaN(payloadValue)) payloadValue = 0;
        }

        // ì›ë˜ ê°’ ë°±ì—… (ë¡¤ë°±ìš©)
        const originalValue = cell.dataset.originalValue;

        // ë¡œì»¬ ë°ì´í„°ì— ì¦‰ì‹œ ì €ì¥
        const localKey = `${propertyId}_${field}`;
        localData.set(localKey, payloadValue);
        cell.dataset.originalValue = String(payloadValue);

        // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€)
        updateCellUI(cell, field, payloadValue);
        
        // ì„±ê³µ í‘œì‹œ (ë‚™ê´€ì )
        showQuickSuccessMessage('âœ“');

        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ì €ì¥ (ë¹„ë™ê¸°, UI ì°¨ë‹¨ ì•ˆí•¨)
        setTimeout(async () => {
          try {
            const response = await fetch('/api/employee/maeiple/update', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: propertyId,
                field: field,
                value: payloadValue
              })
            });
            
            const result = await response.json();
            console.log('ì„œë²„ ë™ê¸°í™”:', result.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
            
            if (!result.success) {
              // ì„œë²„ ì €ì¥ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
              console.error('ì„œë²„ ì €ì¥ ì‹¤íŒ¨, ë¡¤ë°±');
              localData.delete(localKey);
              cell.dataset.originalValue = originalValue;
              updateCellUI(cell, field, originalValue);
              showErrorMessage('ì €ì¥ ì‹¤íŒ¨ - ë¡¤ë°±ë¨');
            }
          } catch (error) {
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ë¡¤ë°±
            console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, ë¡¤ë°±');
            localData.delete(localKey);
            cell.dataset.originalValue = originalValue;
            updateCellUI(cell, field, originalValue);
            showErrorMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ - ë¡¤ë°±ë¨');
          }
        }, 10); // 10ms í›„ ì„œë²„ ì €ì¥ (UI ì¦‰ì‹œ ë°˜ì‘)
      }

      // UI ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜
      function updateCellUI(cell, field, value) {
        if (field === 'status') {
          const badge = cell.querySelector('.status-badge');
          if (badge) {
            const statusClass = value === 'ê³„ì•½ì™„ë£Œ' ? 'status-ê³„ì•½ì™„ë£Œ' : 
                               value === 'ë³´ë¥˜' ? 'status-ë³´ë¥˜' : 
                               value === 'ë¶€ì¬' ? 'status-ë¶€ì¬' : 'status-ê±°ë˜ê°€ëŠ¥';
            badge.className = `status-badge ${statusClass}`;
            badge.textContent = value;
          }
        } else if (field === 'likes') {
          const heartSpan = cell.querySelector('span:first-child');
          const countSpan = cell.querySelector('span:last-child');
          if (heartSpan && countSpan) {
            heartSpan.style.color = value > 0 ? '#ef4444' : '#d1d5db';
            countSpan.textContent = value;
          }
        } else if (field === 'dislikes') {
          const heartSpan = cell.querySelector('span:first-child');
          const countSpan = cell.querySelector('span:last-child');
          if (heartSpan && countSpan) {
            heartSpan.style.color = value > 0 ? '#3b82f6' : '#d1d5db';
            countSpan.textContent = value;
          }
        } else {
          cell.textContent = value || '-';
        }
      }
      






      // ë§¤ë¬¼ ìˆ˜ì •
      function editProperty(propertyId) {
        // ê°„ë‹¨í•œ ìˆ˜ì • ê¸°ëŠ¥ - ì‹¤ì œë¡œëŠ” ëª¨ë‹¬ì´ë‚˜ ë³„ë„ í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ìˆìŒ
        const memo = prompt('ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (memo !== null) {
          updatePropertyMemo(propertyId, memo);
        }
      }

      // ë©”ëª¨ ì—…ë°ì´íŠ¸
      async function updatePropertyMemo(propertyId, memo) {
        try {
          const response = await fetch('/api/employee/maeiple/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: propertyId,
              field: 'memo',
              value: memo
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            // ì¦‰ì‹œ DOM ì—…ë°ì´íŠ¸ (ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
            const row = document.querySelector(`tr[data-id="${propertyId}"]`);
            if (row) {
              const memoCell = row.querySelector('td:nth-child(7) div');
              if (memoCell) {
                memoCell.textContent = memo || 'ë©”ëª¨ ì¶”ê°€';
                memoCell.title = memo || '';
              }
            }
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            showSuccessMessage('ë©”ëª¨ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            showErrorMessage('ë©”ëª¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result.message || result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch (error) {
          console.error('ë©”ëª¨ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
          showErrorMessage('ë©”ëª¨ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // í¼ ì œì¶œ
      document.getElementById('property-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        
        // ì „í™”ë²ˆí˜¸ ì²˜ë¦¬
        if (payload.phone) {
          payload.phone = '010-' + payload.phone;
        }
        
        // ë¶ˆë¦¬ì–¸ ë³€í™˜
        payload.is_occupied = payload.is_occupied === 'true';
        
        try {
          const res = await fetch('/api/employee/maeiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          const data = await res.json();
          
          if (data.success) {
            form.reset();
            
            // ìƒˆë¡œ ì¶”ê°€ëœ ë§¤ë¬¼ì„ í…Œì´ë¸” ë§¨ ìœ„ì— ì¶”ê°€ (ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
            const tbody = document.querySelector('#properties-table tbody');
            if (tbody) {
              const newRow = document.createElement('tr');
              newRow.dataset.id = data.property.id;
              newRow.innerHTML = `
                <td>${data.property.check_date || '-'}</td>
                <td>${data.property.building_number || '-'}ë™ ${data.property.room_number || '-'}í˜¸</td>
                                <td class="editable-cell" data-field="status" data-type="select" data-id="${data.property.id}" onclick="editMaeipleCell(this)">
                  <span class="status-badge status-${data.property.status || 'ê±°ë˜ê°€ëŠ¥'}">${data.property.status || 'ê±°ë˜ê°€ëŠ¥'}</span>
                </td>
                <td>
                  <div style="font-size: 12px; line-height: 1.4;">
                    ${data.property.jeonse_price ? `ì „ì„¸: ${data.property.jeonse_price}ë§Œ` : ''}
                    ${data.property.monthly_rent ? `${data.property.jeonse_price ? '<br>' : ''}ì›”ì„¸: ${data.property.monthly_rent}ë§Œ` : ''}
                    ${data.property.sale_price ? `${data.property.jeonse_price || data.property.monthly_rent ? '<br>' : ''}ë§¤ë§¤: ${data.property.sale_price}ë§Œ` : ''}
                    ${!data.property.jeonse_price && !data.property.monthly_rent && !data.property.sale_price ? '-' : ''}
          </div>
                </td>
                <td class="phone-display" style="font-family: monospace; letter-spacing: 0.5px;">${formatPhone(data.property.phone) || '-'}</td>
                <td>
                  <div class="heart-container" style="display: flex; align-items: center; gap: 8px;">
                    <div class="editable-cell" data-field="likes" data-type="select" data-id="${data.property.id}" onclick="editMaeipleCell(this)" 
                         style="display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;">
                      <span style="font-size: 18px; color: #d1d5db;">â™¥</span>
                      <span style="font-size: 12px; color: #6b7280;">0</span>
                    </div>
                    <div class="editable-cell" data-field="dislikes" data-type="select" data-id="${data.property.id}" onclick="editMaeipleCell(this)" 
                         style="display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s;">
                      <span style="font-size: 18px; color: #d1d5db; transform: rotate(180deg);">â™¥</span>
                      <span style="font-size: 12px; color: #6b7280;">0</span>
                    </div>
                  </div>
                </td>
                <td>
                  <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; color: #3b82f6;" 
                       title="" onclick="showMemoPopup(${data.property.id}, '')">
                    ë©”ëª¨ ì¶”ê°€
                  </div>
                </td>
                <td>
                  <button class="action-btn" onclick="editProperty(${data.property.id})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ìˆ˜ì •</button>
                </td>
              `;
              
              // í…Œì´ë¸” ë§¨ ìœ„ì— ìƒˆ í–‰ ì¶”ê°€
              if (tbody.firstChild) {
                tbody.insertBefore(newRow, tbody.firstChild);
              } else {
                tbody.appendChild(newRow);
              }
            }
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            showSuccessMessage('ë§¤ë¬¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
              } else {
            showErrorMessage('ë§¤ë¬¼ ì¶”ê°€ ì‹¤íŒ¨: ' + (data.error || data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch (err) {
          console.error('ë§¤ë¬¼ ì¶”ê°€ ì˜¤ë¥˜:', err);
          showErrorMessage('ë§¤ë¬¼ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });



      // ë©”ëª¨ íŒì—… í‘œì‹œ
      function showMemoPopup(propertyId, currentMemo) {
        // ê¸°ì¡´ íŒì—… ì œê±°
        document.querySelectorAll('.memo-popup').forEach(p => p.remove());
        document.querySelectorAll('.popup-overlay').forEach(o => o.remove());
        
        // íŒì—… ìƒì„±
        const popup = document.createElement('div');
        popup.className = 'memo-popup';
        popup.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          border-radius: 12px;
          padding: 24px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
          z-index: 1000;
          min-width: 400px;
          max-width: 500px;
        `;
        
        popup.innerHTML = `
          <h3 style="margin: 0 0 20px 0; text-align: center; color: #1f2937;">íŠ¹ì´ì‚¬í•­ ë©”ëª¨</h3>
          <div style="margin-bottom: 20px;">
            <textarea id="memo-text" style="width: 100%; height: 120px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”...">${currentMemo}</textarea>
          </div>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button type="button" class="save-memo-btn" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">ì €ì¥</button>
            <button type="button" class="cancel-memo-btn" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; font-size: 14px;">ì·¨ì†Œ</button>
          </div>
        `;
        
        // ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.createElement('div');
        overlay.className = 'popup-overlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(popup);
        
        // í…ìŠ¤íŠ¸ ì˜ì—­ì— í¬ì»¤ìŠ¤
        const textarea = popup.querySelector('#memo-text');
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        
        // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        popup.querySelector('.save-memo-btn').addEventListener('click', async () => {
          const newMemo = textarea.value.trim();
          
          try {
            const response = await fetch('/api/employee/maeiple/update', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: propertyId,
                field: 'memo',
                value: newMemo
              })
            });
            
            const result = await response.json();
            
            if (result.success) {
              // íŒì—… ì œê±°
              document.body.removeChild(overlay);
              document.body.removeChild(popup);
              
              // ì¦‰ì‹œ DOM ì—…ë°ì´íŠ¸ (ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
              const row = document.querySelector(`tr[data-id="${propertyId}"]`);
              if (row) {
                const memoCell = row.querySelector('td:nth-child(7) div');
                if (memoCell) {
                  memoCell.textContent = newMemo || 'ë©”ëª¨ ì¶”ê°€';
                  memoCell.title = newMemo || '';
                }
              }
              
              // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
              showSuccessMessage('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
              showErrorMessage('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          } catch (error) {
            console.error('ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:', error);
            showErrorMessage('ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        });
        
        // ì·¨ì†Œ ë²„íŠ¼ ë° ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸
        const closePopup = () => {
          document.body.removeChild(overlay);
          document.body.removeChild(popup);
        };
        
        popup.querySelector('.cancel-memo-btn').addEventListener('click', closePopup);
        overlay.addEventListener('click', closePopup);
        
        // ESC í‚¤ë¡œ ë‹«ê¸°
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            closePopup();
            document.removeEventListener('keydown', escHandler);
          }
        });
      }

      // ì„±ê³µ/ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ë“¤
      function showSuccessMessage(message) {
        showMessage(message, 'success');
      }
      
      function showErrorMessage(message) {
        showMessage(message, 'error');
      }
      
      // ë¹ ë¥¸ ì„±ê³µ ë©”ì‹œì§€ (0.5ì´ˆ í›„ ìë™ ì œê±°)
      function showQuickSuccessMessage(message) {
        const quickPopup = document.createElement('div');
        quickPopup.className = 'quick-success-popup';
        quickPopup.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #10b981;
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 18px;
          font-weight: bold;
          z-index: 10000;
          animation: quickFadeIn 0.2s ease-out;
        `;
        
        quickPopup.textContent = message;
        document.body.appendChild(quickPopup);
        
        // 0.3ì´ˆ í›„ ìë™ ì œê±° (ë” ë¹ ë¥´ê²Œ)
        setTimeout(() => {
          if (quickPopup.parentNode) {
            quickPopup.style.animation = 'quickFadeOut 0.15s ease-in';
            setTimeout(() => {
              if (quickPopup.parentNode) {
                document.body.removeChild(quickPopup);
              }
            }, 150);
          }
        }, 300);
      }
      
      function showMessage(message, type) {
        // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
        document.querySelectorAll('.message-popup').forEach(m => m.remove());
        
        const messagePopup = document.createElement('div');
        messagePopup.className = 'message-popup';
        messagePopup.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#10b981' : '#ef4444'};
          color: white;
          padding: 16px 24px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          z-index: 10000;
          font-weight: 500;
          max-width: 300px;
          animation: slideIn 0.3s ease-out;
        `;
        
        messagePopup.textContent = message;
        document.body.appendChild(messagePopup);
        
        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
          if (messagePopup.parentNode) {
            messagePopup.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
              if (messagePopup.parentNode) {
                document.body.removeChild(messagePopup);
              }
            }, 300);
          }
        }, 3000);
      }
      
      // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes quickFadeIn {
          from { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
          to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes quickFadeOut {
          from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
          to { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
        }
      `;
      document.head.appendChild(style);

      // í˜ì´ì§€ ë¡œë“œì‹œ ë§¤ë¬¼ ëª©ë¡ ë¡œë“œ
      loadMyProperties();
      
      // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ë©”ì´í”Œê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ì¦‰ì‹œ ë°˜ì˜ ì‹œìŠ¤í…œ í™œì„±í™”');
      });
    </script>
  </body>
  </html>


